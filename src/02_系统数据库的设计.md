# 第2章：系统数据库的设计

## 2.1 数据库中的表关系

根据业务逻辑的分析，本系统数据库可分为六个数据表，其各自的功能如下所示:

### 表2-1. 数据库中的所有表格及其功能

| 数据表     | 功能描述                       |
|-----------|-------------------------------|
| Users     | 存储用户注册信息。               |
| Books     | 存储书籍基本信息。               |
| Authors   | 存储书籍作者基本信息。            |
| Ordercon  | 存储帐单基本信息及其收件人情况。   |
| Histoy    | 存储系统销售的书籍记录。          |
| Cart      | 作为各用户购物车的临时表。        |

各表关系如下图所示:

## 2.2 数据库中各表的设计

`Users`表用来存储用户注册的基本信息，具体结构如表2-2所示:

### 表2-2. 用户基本信息表(users)

| 字段名       | 数据类型      | 说明          | 备注         |
|-------------|--------------|--------------|-------------|
| Userid      | 数字(自动编号) | 用户ID        | 主键         |
| Usrname     | 文本          | 用户名        | 非空、唯一索引 |
| Usrpwd      | 文本          | 用户密码      | 非空         |
| Usrkey      | 文本          | 找回密码的口令 | 非空         |
| Usrrealname | 文本          | 真实姓名      | 非空         |
| Usrsex      | 文本          | 性别         | 仅限男、女二值 |
| Usrtel      | 文本          | 电话         |              |
| Usremail    | 文本          | E-mail      |              |
| Usraddress  | 文本          | 地址         |              |
| Usrzip      | 文本          | 邮编         |              |
| Usrstate    | 文本          | 省份         |              |
| Usrcity     | 文本          | 城市         |              |

此表用来保存用户注册时填写的基本而必要的信息。其中，`usrid`字段是由系统成功写入记录时系统自动编号，作为`users`表的主键为其他关联表提供连接的主要索引。除此之外，其他表也可以通过`usrname`字段关联`users`表。此字段的更主要功能是用户登录，以及登录后作为一个用户的唯一标识符存储在该用户建立的会话级变量中(即`cookie`的内容,这点在后面的系统详细设计中会进一步介绍)。

`books`表用来存储一本书的基本而必要的信息，具体结构如表2-3所示:

### 表2-3. 书籍基本信息表(books)

| 字段名     | 数据类型         | 说明       | 备注          |
|-----------|-----------------|-----------|--------------|
| Bookid     | 数字(自动编号)  | 书籍 ID     | 主键  |
| Bookname   | 文本           | 书名        | 非空  |
| Bookimgurl | 文本           | 封面图      | URL   |
| Authored   | 数字           | 作者 ID     | 关联authors表 |
| Bookpub    | 文本           | 出版社      | 非空  |
| Bookprice  | 货币           | 单价        | 非空  |
| Booktype   | 文本           | 类别        | 非空  |
| Bookcontent| 文本           | 简介        |       |  
| Booksort   | 数字           | 销售量      | 默认排序字段 |

`authors`表用来存储书籍作者的介绍信息，具体结构如表2-4所示:

### 表2-4 书籍作者信息表(authors)

| 字段名     | 数据类型         |  说明      | 备注          |
|-----------|-----------------|-----------|--------------|
| Authored  | 数字(自动编号)    | 作者 ID    | 主键         |
| Authorname| 文本             | 姓名       | 非空         |
| Authorweb | 文本             | 主页地址   |              |
| Authoremail| 文本            | E-mail    |              |
| Authorcontent| 文本          | 简介      |               |

`authors`表和`books`表形成了多对一关系，二表可以通过`authorid`字段相互查询相关信息，进一步形成在浏览过程中得到的良好用户体验，这点将在系统的详细设计中作进一步的描述。

`ordercon`表存储了帐单的基本信息，具体结构如表2-5 所示:

### 表2-5 帐单基本信息表(ordercon)

| 字段名     | 数据类型         |  说明      | 备注          |
|-----------|-----------------|-----------|--------------|
| Ordered   | 数字(自动编号)    | 帐单 ID    | 主键         |
| Orderdate | 文本             | 建立日期   | 非空          |
| Ordertime | 文本             | 建立时间   | 非空          |
| Ordersendstate| 是/否        | 是否激活   | 非空          |
| Orderrename | 文本           | 收件人姓名 | 非空           |
| Orderaddress | 文本          | 收件人地址 | 非空           |
| Orderzip     | 文本          | 收件人邮编 | 非空           |
| Usrid        | 数字          | 建立者 ID | 关联users表     |
| Orderprice   | 货币          | 帐单金额  | 非空            |

此表中的收件人姓名、地址。邮编和`users`表中的信息并不一定重复，因为用户可以在系统中为他人购买书籍；另外，表中的`ordersendstate`字段表示了交易是否完成，只有被激活的帐单里的书籍才会加入下面的购买历史记录表(histoy)。

`histoy`表记录了系统出售了的书籍，具体结构如表2-6所示:

### 表2-6 历史记录表(histoy)

| 字段名     | 数据类型         |  说明      | 备注          |
|-----------|-----------------|-----------|--------------|
| Id        | 数字(自动编号     | 记录序号   | 主键          |
| Ordered   | 数字            | 所属帐单    | 关联ordercon表|
| Bookid    | 数字            | 书籍 ID    | 关联books表    |
| Usrname   | 文本            | 定购用户    | 非空          |

此表关联了`ordercon`和`books`二表，可以根据查询需要建立各种查询视图，这个将在数据库查询优化中作详细介绍。但是请注意，这里的`usrname`字段在这里并不是作为关联`users`表而存在的，其实，他是作为会话级查询的条件存在的，这点我们将在系统的详细设计中看到。

`cart`表存储了各个用户的购物车情况，具体结果如表2-7所示:

### 表2-7 购物车(cart)

| 字段名     | 数据类型         |  说明      | 备注          |
|-----------|-----------------|-----------|--------------|
| Cartid    | 数字(自动编号)    | 序号       | 主键          |
| Bookid    | 数字             | 书籍 ID    | 关联 books 表 |
| Usrname   | 文本             | 用户名     |  非空         |

此表是和用户关联的会话级临时表，当用户退出会话时清空该表中和该用户相关
的所有记录。他也可以关联`books`表构成相关的查询视图。

## 2.3 数据库设计的优化

为了防止数据存储的冗余，相关的字段可能存储在不同的表中，由一个关联字段保持对应关系。但这样做也导致了我们在某些查询需求下不得不涉及多表查询的问题，这大大增加了查询语句的复杂性，易错且难以维护。因此，我们有必要根据可能的查询需求作一些优化设计，其中视图就是很好的选择之一。

视图是关系型数据库中的一种工具，它不是实际存在的表，但可以根据实际存在的表建立针对各种特定查询需求的虚拟表格。而且，它不涉及具体的物理存储，即它不会造成数据的冗余存储，但可以作为表被查询。由此简化了多表查询的复杂性，也方便了对数据访问权限的控制，使得相应的程序可维护性大大改善。

通过分析本系统查询需求建立了四个查询视图,具体情况表2-8所示:

### 表2-8 各查询视图情况

| 视图名           | 功能描述                             |
|-----------------|-------------------------------------|
| Viewaubk        | 满足 books 和 authors 的关联查询       |
| Viewcart        | 满足 cart 和 books 的关联查询          |
| Viewhistoy      | 满足 histoy 和 books 的关联查询        |
| Vieworders      | 满足 ordercon 和 users 的关联查询      |

以上四个视图都是面向多个表的具体查询需求，在后面的系统设计中，我们可以看到这些视图给数据访问带来的方便。这也从另一方面体现了`ASP+ADO`这种数
据库编程方式式的局限性使得它们对数据库本身的建设有着相当程度的依赖。
